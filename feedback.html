<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kawthoolei Karen Typing - Feedback & Reviews</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .karen-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .star-rating {
            display: flex;
            gap: 4px;
        }

        .star {
            cursor: pointer;
            color: #d1d5db;
            transition: color 0.2s;
        }

        .star.active {
            color: #fbbf24;
        }

        .star:hover {
            color: #f59e0b;
        }

        .feedback-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="karen-gradient min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-4">
            <div>
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-4">
                    <i class="fas fa-keyboard mr-4"></i>
                    Kawthoolei Karen Typing <span class=""><a href="index.html"
                            class="text-2xl bg-gray-700 px-4 py-1 rounded-lg text-yellow-500">Home</a></span>
                </h1>
                <p class="text-xl text-white/90 max-w-2xl mx-auto">
                    Share your experience and help us improve our <span
                        class="bg-gray-100 py-1 px-2 rounded-lg text-blue-700">Kawthoolei</span>
                    Karen
                    language typing application
                </p>
            </div>

        </header>
        <div></div>

        <div class="max-w-6xl mx-auto grid md:grid-cols-2 gap-8">
            <!-- Feedback Form -->
            <div class="feedback-card rounded-2xl py-4 px-8">
                <h2 class="text-2xl font-bold text-white mb-4">
                    <i class="fas fa-comment-dots mr-3"></i>
                    Share Your Feedback
                </h2>

                <form id="feedbackForm" class="space-y-4">
                    <div>
                        <label class="block text-white/90 font-medium mb-2">Your Name</label>
                        <input type="text" id="userName" required
                            class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent"
                            placeholder="Enter your name">
                    </div>

                    <div>
                        <label class="block text-white/90 font-medium mb-2">Email (Optional)</label>
                        <input type="email" id="userEmail"
                            class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent"
                            placeholder="your.email@example.com">
                    </div>

                    <div>
                        <label class="block text-white/90 font-medium mb-3">Rate Your Experience</label>
                        <div class="star-rating text-2xl" id="starRating">
                            <i class="fas fa-star star" data-rating="1"></i>
                            <i class="fas fa-star star" data-rating="2"></i>
                            <i class="fas fa-star star" data-rating="3"></i>
                            <i class="fas fa-star star" data-rating="4"></i>
                            <i class="fas fa-star star" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="rating" value="0">
                    </div>

                    <div>
                        <label class="block text-white/90 font-medium mb-2">Category</label>
                        <select id="category" required
                            class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400"
                            style="color: white; background-color: rgba(255, 255, 255, 0.2);">
                            <option value="" style="color: #374151; background-color: white;">Select a category</option>
                            <option value="usability" style="color: #374151; background-color: white;">Usability
                            </option>
                            <option value="features" style="color: #374151; background-color: white;">Features</option>
                            <option value="performance" style="color: #374151; background-color: white;">Performance
                            </option>
                            <option value="bugs" style="color: #374151; background-color: white;">Bug Report</option>
                            <option value="suggestion" style="color: #374151; background-color: white;">Suggestion
                            </option>
                            <option value="general" style="color: #374151; background-color: white;">General Feedback
                            </option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-white/90 font-medium mb-2">Your Feedback</label>
                        <textarea id="feedback" required rows="5"
                            class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/60 resize-none focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent"
                            placeholder="Tell us about your experience with Kawthoolei Karen Typing..."></textarea>
                    </div>

                    <button type="submit"
                        class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition-colors duration-200 transform hover:scale-105">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Submit Feedback
                    </button>
                </form>
            </div>

            <!-- Reviews Display -->
            <div class="feedback-card rounded-2xl py-2 px-8">
                <h2 class="text-2xl font-bold text-white my-2 mx-8">
                    <i class="fas fa-star mr-3"></i>
                    Recent Reviews
                </h2>

                <!-- Loading indicator -->
                <div id="loadingReviews" class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-white/50 mb-4"></i>
                    <p class="text-white/70">Loading reviews...</p>
                </div>

                <div id="noReviewsMessage" class="text-center py-12 hidden">
                    <i class="fas fa-comments text-6xl text-white/30 mb-4"></i>
                    <h3 class="text-xl text-white/70 mb-2">No reviews yet</h3>
                    <p class="text-white/50">Be the first to share your experience!</p>
                </div>

                <div id="reviewsList" class="space-y-6 hidden">
                    <!-- Reviews will be added here dynamically -->
                </div>

                <div class="mt-6 text-center">
                    <button id="loadMoreBtn"
                        class="bg-white/20 hover:bg-white/30 text-white px-6 py-2 rounded-lg transition-colors duration-200 hidden">
                        Load More Reviews
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="max-w-4xl mx-auto mt-4">
            <div class="feedback-card rounded-2xl p-4">
                <h3 class="text-2xl font-bold text-white text-center mb-4">
                    <i class="fas fa-chart-bar mr-3"></i>
                    Feedback Statistics
                </h3>
                <div class="grid md:grid-cols-4 gap-6 text-center" id="statsContainer">
                    <div>
                        <div class="text-3xl font-bold text-yellow-400 mb-2" id="avgRating">-</div>
                        <div class="text-white/80">Average Rating</div>
                        <div class="text-white/80">တၢ်ထိၣ်ဃူပတီၢ်</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-yellow-400 mb-2" id="totalReviews">0</div>
                        <div class="text-white/80">Total Reviews</div>
                        <div class="text-white/80">တၢ်ကွၢ်ကဒါ</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-yellow-400 mb-2" id="satisfactionRate">-</div>
                        <div class="text-white/80">Satisfaction Rate</div>
                        <div class="text-white/80">မျးကယၤလီၤသးမံ</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-yellow-400 mb-2" id="thisMonth">0</div>
                        <div class="text-white/80">This Month</div>
                        <div class="text-white/80">တလါညါအံၤ</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="relative z-20 px-8 py-2 mt-auto">
        <div class="text-white text-center absolute bottom-2 left-1/2 transform -translate-x-1/2">
            <p class="text-lg">&copy; 2025 Saw Lay Bay (KDHW) - All Rights Reserved</p>
        </div>
    </footer>

    <script>
        // Global variables
        const MAX_VISIBLE_REVIEWS = 4;
        let allReviews = [];
        let visibleReviewsCount = 0;
        let currentRating = 0;

        // Star rating functionality
        const stars = document.querySelectorAll('.star');
        const ratingInput = document.getElementById('rating');

        stars.forEach(star => {
            star.addEventListener('click', function () {
                currentRating = parseInt(this.dataset.rating);
                ratingInput.value = currentRating;
                updateStars();
            });

            star.addEventListener('mouseover', function () {
                const hoverRating = parseInt(this.dataset.rating);
                updateStars(hoverRating);
            });
        });

        document.getElementById('starRating').addEventListener('mouseleave', function () {
            updateStars();
        });

        function updateStars(tempRating = null) {
            const rating = tempRating || currentRating;
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // API Functions
        async function loadReviewsFromAPI() {
            try {
                console.log('Loading reviews from API...');
                
                const response = await fetch('/api/feedback', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                console.log('Response status:', response.status);

                const responseText = await response.text();
                console.log('Raw response:', responseText);

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse response as JSON:', parseError);
                    throw new Error(`Invalid response format: ${responseText}`);
                }
                
                if (response.ok) {
                    console.log('Successfully loaded reviews:', result);
                    return { success: true, reviews: result.reviews || [] };
                } else {
                    console.error('API error:', result);
                    throw new Error(result.error || `HTTP ${response.status}: ${result.details || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Network error loading reviews:', error);
                throw error;
            }
        }

        async function saveReviewToAPI(reviewData) {
            try {
                console.log('Submitting feedback:', reviewData);
                
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(reviewData)
                });

                console.log('Response status:', response.status);

                const responseText = await response.text();
                console.log('Raw response:', responseText);

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse response as JSON:', parseError);
                    throw new Error(`Invalid response format: ${responseText}`);
                }
                
                if (response.ok) {
                    console.log('Successfully submitted feedback:', result);
                    return { success: true, data: result };
                } else {
                    console.error('API error:', result);
                    throw new Error(result.error || `HTTP ${response.status}: ${result.details || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Network error:', error);
                throw error;
            }
        }

        // Form submission
        document.getElementById('feedbackForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
            submitButton.disabled = true;

            try {
                const formData = {
                    name: document.getElementById('userName').value.trim(),
                    email: document.getElementById('userEmail').value.trim(),
                    rating: parseInt(document.getElementById('rating').value),
                    category: document.getElementById('category').value,
                    feedback: document.getElementById('feedback').value.trim(),
                    timestamp: new Date().toISOString()
                };

                console.log('Form data being submitted:', formData);

                // Validation
                if (formData.rating === 0 || isNaN(formData.rating)) {
                    showErrorMessage('Please provide a star rating before submitting.');
                    return;
                }

                if (!formData.name || !formData.category || !formData.feedback) {
                    showErrorMessage('Please fill in all required fields.');
                    return;
                }

                if (formData.rating < 1 || formData.rating > 5) {
                    showErrorMessage('Rating must be between 1 and 5 stars.');
                    return;
                }

                const result = await saveReviewToAPI(formData);

                if (result.success) {
                    // Add new review to local array for immediate display
                    allReviews.unshift(formData);

                    // Update display
                    updateVisibleReviews();
                    updateStatistics();

                    // Reset form
                    this.reset();
                    currentRating = 0;
                    updateStars();

                    // Show success message
                    showSuccessMessage();
                }
            } catch (error) {
                console.error('Submission error:', error);
                showErrorMessage(`Error submitting feedback: ${error.message}`);
            } finally {
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
            }
        });

        function updateVisibleReviews() {
            const reviewsList = document.getElementById('reviewsList');
            const noReviewsMessage = document.getElementById('noReviewsMessage');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const loadingReviews = document.getElementById('loadingReviews');

            // Hide loading indicator
            loadingReviews.classList.add('hidden');

            if (allReviews.length === 0) {
                // Show no reviews message
                noReviewsMessage.classList.remove('hidden');
                reviewsList.classList.add('hidden');
                loadMoreBtn.classList.add('hidden');
                return;
            }

            // Hide no reviews message and show reviews list
            noReviewsMessage.classList.add('hidden');
            reviewsList.classList.remove('hidden');

            // Clear current visible reviews
            reviewsList.innerHTML = '';

            // Show up to MAX_VISIBLE_REVIEWS or current visible count
            const showCount = Math.min(visibleReviewsCount || MAX_VISIBLE_REVIEWS, allReviews.length);
            const visibleReviews = allReviews.slice(0, showCount);

            visibleReviews.forEach(review => {
                addReviewToDOM(review);
            });

            visibleReviewsCount = showCount;

            // Show/hide load more button
            if (allReviews.length > visibleReviewsCount) {
                loadMoreBtn.classList.remove('hidden');
                loadMoreBtn.textContent = `Load More Reviews (${allReviews.length - visibleReviewsCount} remaining)`;
            } else {
                loadMoreBtn.classList.add('hidden');
            }
        }

        function addReviewToDOM(data) {
            const reviewsList = document.getElementById('reviewsList');
            const newReview = document.createElement('div');
            newReview.className = 'bg-white/10 rounded-lg p-4 border border-white/20';

            const starsHtml = Array.from({ length: 5 }, (_, i) =>
                i < data.rating ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>'
            ).join('');

            const timeAgo = getTimeAgo(data.timestamp);

            newReview.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-semibold text-white">${escapeHtml(data.name)}</h4>
                    <div class="flex text-yellow-400">
                        ${starsHtml}
                    </div>
                </div>
                <p class="text-white/80 text-sm mb-2">${escapeHtml(data.category)} • ${timeAgo}</p>
                <p class="text-white/90">${escapeHtml(data.feedback)}</p>
            `;

            reviewsList.appendChild(newReview);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const reviewTime = new Date(timestamp);
            const diffMs = now - reviewTime;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minutes ago`;

            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} hours ago`;

            const diffDays = Math.floor(diffHours / 24);
            if (diffDays < 7) return `${diffDays} days ago`;

            const diffWeeks = Math.floor(diffDays / 7);
            if (diffWeeks < 4) return `${diffWeeks} weeks ago`;

            const diffMonths = Math.floor(diffDays / 30);
            return `${diffMonths} months ago`;
        }

        function updateStatistics() {
            if (allReviews.length === 0) {
                document.getElementById('avgRating').textContent = '-';
                document.getElementById('totalReviews').textContent = '0';
                document.getElementById('satisfactionRate').textContent = '-';
                document.getElementById('thisMonth').textContent = '0';
                return;
            }

            // Calculate average rating
            const totalRating = allReviews.reduce((sum, review) => sum + review.rating, 0);
            const avgRating = (totalRating / allReviews.length).toFixed(1);
            document.getElementById('avgRating').textContent = avgRating;

            // Total reviews
            document.getElementById('totalReviews').textContent = allReviews.length;

            // Satisfaction rate (4+ stars)
            const satisfiedReviews = allReviews.filter(review => review.rating >= 4).length;
            const satisfactionRate = Math.round((satisfiedReviews / allReviews.length) * 100);
            document.getElementById('satisfactionRate').textContent = satisfactionRate + '%';

            // This month reviews
            const now = new Date();
            const thisMonth = allReviews.filter(review => {
                const reviewDate = new Date(review.timestamp);
                return reviewDate.getMonth() === now.getMonth() &&
                    reviewDate.getFullYear() === now.getFullYear();
            }).length;
            document.getElementById('thisMonth').textContent = thisMonth;
        }

        function showSuccessMessage() {
            showMessage('Feedback submitted successfully! Thank you for your review.', 'success');
        }

        function showErrorMessage(message) {
            showMessage(message, 'error');
        }

        function showMessage(message, type = 'success') {
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300 max-w-md`;
            messageDiv.innerHTML = `<i class="fas ${icon} mr-2"></i>${message}`;

            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.classList.remove('translate-x-full');
            }, 100);

            setTimeout(() => {
                messageDiv.classList.add('translate-x-full');
                setTimeout(() => {
                    if (document.body.contains(messageDiv)) {
                        document.body.removeChild(messageDiv);
                    }
                }, 300);
            }, type === 'error' ? 5000 : 3000);
        }

        // Load more reviews functionality
        document.getElementById('loadMoreBtn').addEventListener('click', function () {
            const originalText = this.textContent;
            this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            this.disabled = true;

            setTimeout(() => {
                // Show more reviews (add 4 more or show all remaining)
                const remainingReviews = allReviews.length - visibleReviewsCount;
                const newShowCount = Math.min(visibleReviewsCount + MAX_VISIBLE_REVIEWS, allReviews.length);
                
                // Add the new reviews to the DOM
                const newReviews = allReviews.slice(visibleReviewsCount, newShowCount);
                newReviews.forEach(review => {
                    addReviewToDOM(review);
                });
                
                visibleReviewsCount = newShowCount;
                
                // Update button state
                if (visibleReviewsCount >= allReviews.length) {
                    this.classList.add('hidden');
                } else {
                    const remaining = allReviews.length - visibleReviewsCount;
                    this.textContent = `Load More Reviews (${remaining} remaining)`;
                    this.disabled = false;
                }
            }, 800);
        });

        // Initialize page by loading reviews from API
        async function initializePage() {
            try {
                console.log('Initializing page...');
                
                // Load reviews from Airtable
                const result = await loadReviewsFromAPI();
                
                if (result.success) {
                    allReviews = result.reviews || [];
                    console.log(`Loaded ${allReviews.length} reviews from Airtable`);
                } else {
                    console.error('Failed to load reviews');
                    allReviews = [];
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
                allReviews = [];
                
                // Show error message to user
                showErrorMessage('Unable to load existing reviews. You can still submit new feedback.');
            }
            
            // Update display with loaded reviews
            updateVisibleReviews();
            updateStatistics();
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            updateStars();
        });

        // Also initialize immediately if DOM is already loaded
        if (document.readyState === 'loading') {
            // Do nothing, we already have the DOMContentLoaded listener
        } else {
            // DOM already loaded
            initializePage();
            updateStars();
        }
    </script>
</body>

</html>
